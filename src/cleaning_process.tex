\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Cleaning},
            pdfauthor={Kaushik Mohan},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\newcommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Cleaning}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Kaushik Mohan}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{11/14/2018}


\begin{document}
\maketitle

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{load}\NormalTok{(}\DataTypeTok{file=}\StringTok{"../data/pre_cleaning_sales_data.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{commercial_condos <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"RA"}\NormalTok{,}\StringTok{"RB"}\NormalTok{,}\StringTok{"RG"}\NormalTok{,}\StringTok{"RH"}\NormalTok{,}\StringTok{"RK"}\NormalTok{,}\StringTok{"RP"}\NormalTok{,}\StringTok{"RS"}\NormalTok{,}\StringTok{"RP"}\NormalTok{,}\StringTok{"RW"}\NormalTok{,}\StringTok{"R5"}\NormalTok{)}
\NormalTok{sales_data <-}\StringTok{ }\NormalTok{sales_data[}\OperatorTok{!}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{building_class_at_time_of_sale }\OperatorTok{%in%}\StringTok{ }\NormalTok{commercial_condos),]}
\NormalTok{N <-}\StringTok{ }\KeywordTok{dim}\NormalTok{(sales_data)[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sales_data}\OperatorTok{$}\NormalTok{BldgArea <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{BldgArea)}
\NormalTok{sales_data}\OperatorTok{$}\NormalTok{ResArea <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{ResArea)}
\end{Highlighting}
\end{Shaded}

\hypertarget{datasets}{%
\subsection{Datasets}\label{datasets}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  NYC Annualized Property Sales Data (2012-2017)
\item
  MapPLUTO (18v1)
\item
  Geoclient API v1.1
\end{enumerate}

\hypertarget{merging-process}{%
\subsection{Merging Process}\label{merging-process}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Subset building classes A,B,C,D,R,S as these are the ones coming under
  the residential tax class
\item
  Merge with MapPLUTO data on \texttt{Borough},\texttt{Block} and
  \texttt{Lot}
\item
  Condo listings don't merge as there is a mismatch in BBL with MapPLUTO
  data. Therefore, we use Geoclient API to get the
  \texttt{condominiumBillingBbl} for the condos and then merge with
  MapPLUTO data on the \texttt{BBL}.
\end{enumerate}

\hypertarget{cleaning-data}{%
\subsection{Cleaning Data}\label{cleaning-data}}

\hypertarget{sale-price}{%
\subsubsection{1. Sale Price}\label{sale-price}}

First, we analyse the distribution of the sale prices. We note a sharp
peak at 1, which is a price of \(\$10\). Also, from the overall
distribution, we observe a lot of spikes below \(\$10,000\) (red line).
Hence, we choose to remove all the cases where the Price is less than
\(\$10,000\).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(}\KeywordTok{log10}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{sale_price)),}\DataTypeTok{main=}\StringTok{"Log(base 10) Sales Price"}\NormalTok{)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v=}\KeywordTok{log10}\NormalTok{(}\DecValTok{10000}\NormalTok{),}\DataTypeTok{col=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{cleaning_process_files/figure-latex/unnamed-chunk-4-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s2 <-}\StringTok{ }\NormalTok{sales_data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(sale_price }\OperatorTok{<=}\StringTok{ }\DecValTok{10000}\NormalTok{)}
\KeywordTok{table}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{building_class)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##      A      B      C      D      R      S 
## 100280  87132  66717  84444  80378  12247
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{table}\NormalTok{(s2}\OperatorTok{$}\NormalTok{building_class)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##     A     B     C     D     R     S 
## 33240 34545 24778  9178     5  5783
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sales_data <-}\StringTok{ }\NormalTok{sales_data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(sale_price }\OperatorTok{>}\StringTok{ }\DecValTok{10000}\NormalTok{)}
\NormalTok{N_prev <-}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{(}\KeywordTok{dim}\NormalTok{(sales_data)[}\DecValTok{1}\NormalTok{]}\OperatorTok{/}\NormalTok{N))}\OperatorTok{*}\DecValTok{100}
\KeywordTok{paste0}\NormalTok{(}\KeywordTok{round}\NormalTok{((}\DecValTok{1}\OperatorTok{-}\NormalTok{(}\KeywordTok{dim}\NormalTok{(sales_data)[}\DecValTok{1}\NormalTok{]}\OperatorTok{/}\NormalTok{N))}\OperatorTok{*}\DecValTok{100}\NormalTok{,}\DecValTok{2}\NormalTok{),}\StringTok{"% rows removed"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "24.94% rows removed"
\end{verbatim}

\hypertarget{area}{%
\subsubsection{2. Area}\label{area}}

We need the are of the building because we would calculate the price per
sq. ft which is a better measure than the sale price itself.

We have \texttt{Gross\ Sq.\ Ft} in the Property Sales Data and Building
Floor Area (\texttt{BldgArea}) Residential Floor Area (\texttt{ResArea})
in the MapPLUTO Data. We note that \texttt{Gross\ Sq.\ Ft} strongly
associated and predicted by with both these with a slope of nearly 1,
except for the cases when the \texttt{Gross\ Sq.\ Ft} is 0, of course.
Given \texttt{Bldg\ Area} has way fewer missing values, we choose to
predict the missing values in \texttt{Gross\ Sq.\ Ft} with the using the
\texttt{Bldg\ Area} from MapPLUTO data based on the simple linear model
we fit on the non-missing ones.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{par}\NormalTok{(}\DataTypeTok{mfrow=}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(}\DataTypeTok{y=}\NormalTok{sales_data}\OperatorTok{$}\NormalTok{gross_square_feet,}\DataTypeTok{x=}\NormalTok{sales_data}\OperatorTok{$}\NormalTok{ResArea,}
     \DataTypeTok{ylab=}\StringTok{"Gross Sq. Ft (Property Sales)"}\NormalTok{,}
     \DataTypeTok{xlab=}\StringTok{"Residential Area (MapPLUTO)"}\NormalTok{)}

\KeywordTok{plot}\NormalTok{(}\DataTypeTok{y=}\NormalTok{sales_data}\OperatorTok{$}\NormalTok{gross_square_feet,}\DataTypeTok{x=}\NormalTok{sales_data}\OperatorTok{$}\NormalTok{BldgArea,}
     \DataTypeTok{ylab=}\StringTok{"Gross Sq. Ft (Property Sales)"}\NormalTok{,}
     \DataTypeTok{xlab=}\StringTok{"Building Area (MapPLUTO)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{cleaning_process_files/figure-latex/unnamed-chunk-7-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# plot(y=sales_data$gross_square_feet[sales_data$building_class == "A"],x=sales_data$BldgArea[sales_data$building_class == "A"],}
\CommentTok{#      ylab="Gross Sq. Ft (Property Sales)",}
\CommentTok{#      xlab="Building Area (MapPLUTO)",xlim=c(0,15000))}
\CommentTok{# }
\CommentTok{# }
\CommentTok{# plot(y=sales_data$gross_square_feet[sales_data$building_class == "B"],x=sales_data$BldgArea[sales_data$building_class == "B"],}
\CommentTok{#      ylab="Gross Sq. Ft (Property Sales)",}
\CommentTok{#      xlab="Building Area (MapPLUTO)",xlim=c(0,3e4))}
\CommentTok{# }
\CommentTok{# }
\CommentTok{# plot(y=sales_data$gross_square_feet[sales_data$building_class == "C"],x=sales_data$BldgArea[sales_data$building_class == "C"],}
\CommentTok{#      ylab="Gross Sq. Ft (Property Sales)",}
\CommentTok{#      xlab="Building Area (MapPLUTO)",xlim=c(0,0.5e6))}
\CommentTok{# }
\CommentTok{# plot(y=sales_data$gross_square_feet[sales_data$building_class == "D"],x=sales_data$BldgArea[sales_data$building_class == "D"],}
\CommentTok{#      ylab="Gross Sq. Ft (Property Sales)",}
\CommentTok{#      xlab="Building Area (MapPLUTO)",xlim=c(0,4e6))}
\CommentTok{# }
\CommentTok{# plot(y=sales_data$gross_square_feet[sales_data$building_class == "R"],x=sales_data$BldgArea[sales_data$building_class == "R"],}
\CommentTok{#      ylab="Gross Sq. Ft (Property Sales)",}
\CommentTok{#      xlab="Building Area (MapPLUTO)",xlim=c(0,4e5))}
\CommentTok{# }
\CommentTok{# plot(y=sales_data$gross_square_feet[sales_data$building_class == "S"],x=sales_data$BldgArea[sales_data$building_class == "S"],}
\CommentTok{#      ylab="Gross Sq. Ft (Property Sales)",}
\CommentTok{#      xlab="Building Area (MapPLUTO)",xlim=c(0,20000))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get_subset_data <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(sales_data,bclass,xlim)\{}
\NormalTok{    s <-}\StringTok{ }\NormalTok{sales_data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(BldgArea }\OperatorTok{>}\StringTok{ }\DecValTok{100} \OperatorTok{&}\StringTok{ }\NormalTok{BldgArea }\OperatorTok{<}\StringTok{ }\NormalTok{xlim }\OperatorTok{&}\StringTok{ }\NormalTok{building_class }\OperatorTok{==}\StringTok{ }\NormalTok{bclass }\OperatorTok{&}\StringTok{ }\NormalTok{gross_square_feet }\OperatorTok{>}\StringTok{ }\DecValTok{100}\NormalTok{)}
    \KeywordTok{return}\NormalTok{(s[,}\KeywordTok{c}\NormalTok{(}\StringTok{"gross_square_feet"}\NormalTok{,}\StringTok{"BldgArea"}\NormalTok{,}\StringTok{"Borough"}\NormalTok{ ,}\StringTok{"building_class"}\NormalTok{)])}
\NormalTok{\}}

\NormalTok{s.A <-}\StringTok{ }\KeywordTok{get_subset_data}\NormalTok{(sales_data,}\StringTok{"A"}\NormalTok{,}\DecValTok{15000}\NormalTok{)}
\NormalTok{s.B <-}\StringTok{ }\KeywordTok{get_subset_data}\NormalTok{(sales_data,}\StringTok{"B"}\NormalTok{,}\FloatTok{3e4}\NormalTok{)}
\NormalTok{s.C <-}\StringTok{ }\KeywordTok{get_subset_data}\NormalTok{(sales_data,}\StringTok{"C"}\NormalTok{,}\FloatTok{0.5e6}\NormalTok{)}
\NormalTok{s.D <-}\StringTok{ }\KeywordTok{get_subset_data}\NormalTok{(sales_data,}\StringTok{"D"}\NormalTok{,}\FloatTok{4e6}\NormalTok{)}
\NormalTok{s.R <-}\StringTok{ }\KeywordTok{get_subset_data}\NormalTok{(sales_data,}\StringTok{"R"}\NormalTok{,}\FloatTok{3e5}\NormalTok{)}
\NormalTok{s.S <-}\StringTok{ }\KeywordTok{get_subset_data}\NormalTok{(sales_data,}\StringTok{"S"}\NormalTok{,}\DecValTok{20000}\NormalTok{)}

\NormalTok{fitting_subset <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(s.A,s.B,s.C,s.D,s.R,s.S)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{f2 <-}\StringTok{ }\KeywordTok{lm}\NormalTok{(gross_square_feet }\OperatorTok{~}\StringTok{ }\DecValTok{0} \OperatorTok{+}\StringTok{ }\NormalTok{BldgArea }\OperatorTok{+}\StringTok{ }\NormalTok{building_class }\OperatorTok{+}\StringTok{ }\NormalTok{building_class}\OperatorTok{*}\NormalTok{BldgArea }\OperatorTok{+}\StringTok{ }\NormalTok{Borough,}\DataTypeTok{data=}\NormalTok{fitting_subset)}
\KeywordTok{summary}\NormalTok{(f2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = gross_square_feet ~ 0 + BldgArea + building_class + 
##     building_class * BldgArea + Borough, data = fitting_subset)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -394944    -164     -51     121  534704 
## 
## Coefficients:
##                            Estimate Std. Error t value Pr(>|t|)    
## BldgArea                  7.732e-01  1.235e-02  62.625  < 2e-16 ***
## building_classA           3.763e+02  2.617e+01  14.381  < 2e-16 ***
## building_classB           1.136e+03  3.035e+01  37.421  < 2e-16 ***
## building_classC           3.325e+02  1.956e+01  17.001  < 2e-16 ***
## building_classD          -1.455e+02  6.633e+01  -2.193  0.02831 *  
## building_classR           3.998e+04  5.399e+02  74.044  < 2e-16 ***
## building_classS           5.584e+02  7.270e+01   7.681 1.59e-14 ***
## BoroughBX                 1.446e+02  2.289e+01   6.317 2.67e-10 ***
## BoroughMN                 1.836e+02  3.878e+01   4.735 2.20e-06 ***
## BoroughQN                -4.870e+01  1.642e+01  -2.966  0.00302 ** 
## BoroughSI                 5.598e+01  2.137e+01   2.619  0.00881 ** 
## BldgArea:building_classB -2.788e-01  1.701e-02 -16.389  < 2e-16 ***
## BldgArea:building_classC  1.632e-01  1.242e-02  13.136  < 2e-16 ***
## BldgArea:building_classD  2.270e-01  1.235e-02  18.380  < 2e-16 ***
## BldgArea:building_classR -4.821e-01  1.314e-02 -36.679  < 2e-16 ***
## BldgArea:building_classS  4.546e-02  2.131e-02   2.133  0.03295 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 2534 on 153065 degrees of freedom
## Multiple R-squared:  0.9884, Adjusted R-squared:  0.9884 
## F-statistic: 8.13e+05 on 16 and 153065 DF,  p-value: < 2.2e-16
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sales_data <-}\StringTok{ }\NormalTok{sales_data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{area =}\NormalTok{ gross_square_feet )}

\CommentTok{# plot(density(predict(f2, newdata=sales_data[sales_data$area == 0,])))}

\NormalTok{sales_data}\OperatorTok{$}\NormalTok{area[sales_data}\OperatorTok{$}\NormalTok{area }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{] <-}\StringTok{ }\KeywordTok{predict}\NormalTok{(f2,}
                                                 \DataTypeTok{newdata =}\NormalTok{ sales_data[sales_data}\OperatorTok{$}\NormalTok{area }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{,}\KeywordTok{c}\NormalTok{(}\StringTok{"BldgArea"}\NormalTok{,}\StringTok{"Borough"}\NormalTok{ ,}\StringTok{"building_class"}\NormalTok{)])}

\CommentTok{# table(sales_data$building_class[sales_data$area <= 0])}
\end{Highlighting}
\end{Shaded}

\hypertarget{filtering-by-area}{%
\subsubsection{3. Filtering by area}\label{filtering-by-area}}

We see a few cases with area less than 100 sq.ft (red line). We remove
these.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(}\KeywordTok{log10}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{area)),}\StringTok{"Log(base 10) Area"}\NormalTok{)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v=}\KeywordTok{log10}\NormalTok{(}\DecValTok{100}\NormalTok{),}\DataTypeTok{col=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{cleaning_process_files/figure-latex/unnamed-chunk-11-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sales_data <-}\StringTok{ }\NormalTok{sales_data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(area }\OperatorTok{>}\StringTok{ }\DecValTok{100}\NormalTok{)}
\KeywordTok{paste0}\NormalTok{(}\KeywordTok{round}\NormalTok{((}\DecValTok{1}\OperatorTok{-}\NormalTok{(}\KeywordTok{dim}\NormalTok{(sales_data)[}\DecValTok{1}\NormalTok{]}\OperatorTok{/}\NormalTok{N))}\OperatorTok{*}\DecValTok{100} \OperatorTok{-}\StringTok{ }\NormalTok{N_prev,}\DecValTok{3}\NormalTok{),}\StringTok{"% rows removed"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "0.003% rows removed"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{N_prev <-}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{(}\KeywordTok{dim}\NormalTok{(sales_data)[}\DecValTok{1}\NormalTok{]}\OperatorTok{/}\NormalTok{N))}\OperatorTok{*}\DecValTok{100}
\end{Highlighting}
\end{Shaded}

\hypertarget{price-per-sq.-ft}{%
\subsubsection{4. Price per sq. ft}\label{price-per-sq.-ft}}

We compute Price per square feet from the sale price and above computed
area. Looking at the distribution, we see a two modes around \(\$10\)
per sq. feet and \(\$1000\) per sq.ft with a dip around \(\$50\) (red
line).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sales_data}\OperatorTok{$}\NormalTok{price_per_sqft <-}\StringTok{ }\NormalTok{sales_data}\OperatorTok{$}\NormalTok{sale_price}\OperatorTok{/}\NormalTok{sales_data}\OperatorTok{$}\NormalTok{area}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(}\KeywordTok{log10}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{price_per_sqft)),}\DataTypeTok{main=}\StringTok{"Log(base 10) Price per sq. ft"}\NormalTok{)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v=}\KeywordTok{log10}\NormalTok{(}\DecValTok{50}\NormalTok{),}\DataTypeTok{col=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{cleaning_process_files/figure-latex/unnamed-chunk-14-1.pdf}

Majority of the ones with prices lower than \(\$50\) per sq. ft are
Condos and Co-ops (Class R and D respectively). This seems highly odd as
we would expect these to be the most expensive.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s2 <-}\StringTok{ }\NormalTok{sales_data}\OperatorTok{$}\NormalTok{building_class[sales_data}\OperatorTok{$}\NormalTok{price_per_sqft }\OperatorTok{<=}\StringTok{ }\DecValTok{50}\NormalTok{]}
\KeywordTok{table}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{building_class)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##     A     B     C     D     R     S 
## 67036 52585 41934 75266 80373  6464
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{table}\NormalTok{(s2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## s2
##     A     B     C     D     R     S 
##   785  1061 12492 71705 75147   233
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# sales_data <- sales_data %>% filter(price_per_sqft > 50)}
\CommentTok{# paste0(round((1-(dim(sales_data)[1]/N))*100 - N_prev,2),"% rows removed")}
\CommentTok{# N_prev <- (1-(dim(sales_data)[1]/N))*100}
\end{Highlighting}
\end{Shaded}

\hypertarget{checking-price-distributions}{%
\paragraph{4.1 Checking Price
Distributions}\label{checking-price-distributions}}

Below are the marginals by Borough and Building class and distributions
of price per square feet by building class. It is a bit odd that Condo
(Building Class R) and Coop Apartment (Building Class D) prices have a
very different distribution compared to the rest. Also, the scale is
completely off with respect to price estimates for New York City. Zillow
suggests the Median price per sq. ft of a condo in Manhattan is closer
to \$1800.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sales_data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{group_by}\NormalTok{(Borough) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{median_price_per_sqft =} \KeywordTok{median}\NormalTok{(price_per_sqft))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 2
##   Borough median_price_per_sqft
##   <chr>                   <dbl>
## 1 BK                      142. 
## 2 BX                      138. 
## 3 MN                       11.5
## 4 QN                      193. 
## 5 SI                      243.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sales_data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{group_by}\NormalTok{(building_class) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{median_price_per_sqft =} \KeywordTok{median}\NormalTok{(price_per_sqft))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 2
##   building_class median_price_per_sqft
##   <chr>                          <dbl>
## 1 A                             318.  
## 2 B                             268.  
## 3 C                             148.  
## 4 D                               2.96
## 5 R                              10.9 
## 6 S                             259.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sales_data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{group_by}\NormalTok{(Borough,building_class) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{median_price_per_sqft =} \KeywordTok{median}\NormalTok{(price_per_sqft))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 30 x 3
## # Groups:   Borough [?]
##    Borough building_class median_price_per_sqft
##    <chr>   <chr>                          <dbl>
##  1 BK      A                             385.  
##  2 BK      B                             302.  
##  3 BK      C                             204.  
##  4 BK      D                               2.48
##  5 BK      R                              12.2 
##  6 BK      S                             268.  
##  7 BX      A                             236.  
##  8 BX      B                             188.  
##  9 BX      C                             138.  
## 10 BX      D                               1.40
## # ... with 20 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{uq <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{building_class)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \KeywordTok{seq_along}\NormalTok{(}\KeywordTok{unique}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{building_class)))\{}
  \KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(}\KeywordTok{log10}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{price_per_sqft[sales_data}\OperatorTok{$}\NormalTok{building_class }\OperatorTok{==}\StringTok{ }\NormalTok{uq[i]])),}\DataTypeTok{main=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"Building Class "}\NormalTok{,uq[i]))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\includegraphics{cleaning_process_files/figure-latex/unnamed-chunk-18-1.pdf}
\includegraphics{cleaning_process_files/figure-latex/unnamed-chunk-18-2.pdf}
\includegraphics{cleaning_process_files/figure-latex/unnamed-chunk-18-3.pdf}
\includegraphics{cleaning_process_files/figure-latex/unnamed-chunk-18-4.pdf}
\includegraphics{cleaning_process_files/figure-latex/unnamed-chunk-18-5.pdf}
\includegraphics{cleaning_process_files/figure-latex/unnamed-chunk-18-6.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sales_data}\OperatorTok{$}\NormalTok{adj_ppsf <-}\StringTok{ }\NormalTok{sales_data}\OperatorTok{$}\NormalTok{price_per_sqft}\OperatorTok{*}\NormalTok{sales_data}\OperatorTok{$}\NormalTok{ResidFAR}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{## Fixing years}
\NormalTok{sales_data}\OperatorTok{$}\NormalTok{year[}\KeywordTok{is.na}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{year)] <-}\StringTok{ }\KeywordTok{year}\NormalTok{(}\KeywordTok{as.Date}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{sale_date[}\KeywordTok{is.na}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{year)],}\DataTypeTok{origin=}\StringTok{"1900-01-01"}\NormalTok{)) }

\NormalTok{## adding tract as per census}
\NormalTok{sales_data}\OperatorTok{$}\NormalTok{Tract2010 <-}\StringTok{ }\KeywordTok{str_pad}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{Tract2010,}\DecValTok{6}\NormalTok{,}\DataTypeTok{side=}\StringTok{"right"}\NormalTok{,}\DataTypeTok{pad=}\StringTok{"0"}\NormalTok{)}
\NormalTok{sales_data}\OperatorTok{$}\NormalTok{boro_ct201 <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(sales_data}\OperatorTok{$}\NormalTok{borough,sales_data}\OperatorTok{$}\NormalTok{Tract2010)}
\end{Highlighting}
\end{Shaded}


\end{document}
